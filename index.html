<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>발로란트 내전 전적 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#111; color:#eee; }
    .nav-tabs .nav-link.active { background:#222; color:#0ff; font-weight:bold; }
    .table { color:#ddd; font-size:0.9rem; }
    .table thead { background:#222; }
    .table-striped tbody tr:nth-of-type(odd) { background:#1a1a1a; }
    .card { background:#1a1a1a; border:1px solid #333; cursor:pointer; }
    .card:hover { border-color:#0ff; }
    .modal-content { background:#1a1a1a; color:#eee; }
    .badge-win { background:#28a745; }
    .badge-lose { background:#dc3545; }
    .badge-up { background:#0ff; color:#000; }
    .badge-down { background:#f00; }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center mb-4">발로란트 내전 전적 시스템</h1>
  <ul class="nav nav-tabs justify-content-center mb-4">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inputTab">내전 정보 입력</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#recordTab">내전 전적</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#searchTab">전적 검색</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tierTab">티어표</a></li>
  </ul>

  <div class="tab-content">
    <!-- 입력 -->
    <div class="tab-pane fade show active" id="inputTab">
      <div class="card p-3">
        <h4>내전 정보 입력</h4>
        <form id="matchForm">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">맵 이름</label><input type="text" class="form-control" name="map" required></div>
            <div class="col-md-4"><label class="form-label">스코어</label><input type="text" class="form-control" name="score" required></div>
            <div class="col-md-4"><label class="form-label">날짜</label><input type="date" class="form-control" name="date" required></div>
          </div>
          <hr>
          <label class="form-label">전적 복붙</label>
          <textarea class="form-control mb-2" rows="12" name="raw"></textarea>
          <button type="submit" class="btn btn-primary">저장</button>
        </form>
      </div>
    </div>

    <!-- 전적 -->
    <div class="tab-pane fade" id="recordTab">
      <h4>내전 전적</h4>
      <div id="recordList"></div>
    </div>

    <!-- 전적 검색 -->
    <div class="tab-pane fade" id="searchTab">
      <h4>전적 검색</h4>
      <input type="text" id="searchUser" class="form-control mb-2" placeholder="닉네임#태그 입력">
      <button class="btn btn-info mb-3" onclick="searchStats()">검색</button>
      <div id="searchResult"></div>
    </div>

    <!-- 티어표 -->
    <div class="tab-pane fade" id="tierTab">
      <h4>티어표</h4>
      <table class="table table-bordered table-striped">
        <thead><tr><th>순위</th><th>닉네임</th><th>티어</th><th>MMR</th><th>총 게임</th><th>승</th><th>패</th><th>승률</th></tr></thead>
        <tbody id="tierTable"></tbody>
      </table>
      <h5 class="mt-4">MMR 변동 가중치</h5>
      <pre>
기본: 승리 +25, 패배 -20
ACS: 상위 30% +5, 하위 30% -5
KDA: ±0~5
FK/FD/MK 보정
헤드율: 평균 이상 +3, 이하 -3
연승/연패: 3연승 +10, 5연승 +20 / 3연패 -10, 5연패 -20
MVP: 최근 10판 중 1개당 +2, 최대 +20
      </pre>
    </div>
  </div>
</div>

<!-- 상세 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">전적 상세</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="detailContent"></div>
  </div></div>
</div>

<script>
// Firebase
const firebaseConfig={apiKey:"AIzaSyDw2nAlGyepFTQQVN8m6slQmtLyc5vR0_s",authDomain:"valo-cf536.firebaseapp.com",projectId:"valo-cf536",storageBucket:"valo-cf536.appspot.com",messagingSenderId:"463328045633",appId:"1:463328045633:web:7785fd381903d8cee874c0"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// 티어 구간
const tiers=["아이언1","아이언2","아이언3","브론즈1","브론즈2","브론즈3","실버1","실버2","실버3","골드1","골드2","골드3","플래티넘1","플래티넘2","플래티넘3","다이아1","다이아2","다이아3","이모탈1","이모탈2","이모탈3","레디언트"];
function getTier(mmr){let idx=Math.floor(mmr/100)-9; if(idx<0) idx=0; if(idx>=tiers.length) idx=tiers.length-1; return tiers[idx];}

// --- 파서 ---
function parsePlayers(text){
  let lines=text.split("\n").map(l=>l.trim()).filter(l=>l);
  let players=[],current=[];
  lines.forEach(line=>{
    current.push(...line.split(/\s+/));
    if(/\d+\s*\/\s*\d+\s*\/\s*\d+/.test(line)){
      if(current.length>=12){
        let p={};let idx=0;
        p.agent=current[idx++];
        p.name=current[idx++]; while(!p.name.includes("#")&&idx<current.length){p.name+=" "+current[idx++];}
        p.tier=current[idx++]||""; p.position=current[idx++]||"";
        p.rankText=current[idx++]||"";
        p.kda=current[idx++]+" "+current[idx++]+" "+current[idx++];
        p.ratio=current[idx++]||""; p.acs=current[idx++]||""; p.adr=current[idx++]||"";
        p.dd=current[idx++]||""; p.hs=current[idx++]||""; p.fk=current[idx++]||""; p.fd=current[idx++]||""; p.mk=current[idx++]||"";
        players.push(p); current=[];
      }
    }
  });
  return players;
}
function parseMatch(raw){
  let [teamAraw,teamBraw]=raw.split(/팀 B/); if(!teamBraw) return {team1:[],team2:[]};
  let team1=parsePlayers(teamAraw.replace(/팀 A.*\n/,""));
  let team2=parsePlayers(teamBraw.replace(/팀 B.*\n/,""));
  return {team1,team2};
}

// 저장
document.getElementById("matchForm").addEventListener("submit",async e=>{
  e.preventDefault();
  let data=Object.fromEntries(new FormData(e.target).entries());
  let parsed=parseMatch(data.raw);
  await db.collection("matches").add({map:data.map,score:data.score,date:data.date,team1:parsed.team1,team2:parsed.team2,created:firebase.firestore.FieldValue.serverTimestamp()});
  alert("저장 완료!"); e.target.reset();
});

// 목록
db.collection("matches").orderBy("created","desc").onSnapshot(snap=>{
  let list=document.getElementById("recordList"); list.innerHTML="";
  snap.forEach(doc=>{
    let m=doc.data();
    let card=document.createElement("div");
    card.className="card p-2 mb-2"; card.innerHTML=`<b>${m.map}</b> - ${m.score} (${m.date})`;
    card.onclick=()=>showDetail(m); list.appendChild(card);
  });
});

// 모달
function showDetail(m){
  let [sA,sB]=m.score.split("-").map(x=>+x);
  let html=`<h5>${m.map} (${m.score}, ${m.date})</h5>`;
  function render(players,label,isWin){
    let badge=isWin?'<span class="badge badge-win">승리</span>':'<span class="badge badge-lose">패배</span>';
    let out=`<h6>${label} ${badge}</h6><table class="table table-bordered table-sm table-striped"><thead><tr>
    <th>요원</th><th>닉네임</th><th>티어</th><th>순위</th><th>KDA</th><th>비율</th><th>ACS</th><th>ADR</th><th>DDΔ</th><th>HS%</th><th>FK</th><th>FD</th><th>MK</th></tr></thead><tbody>`;
    players.forEach(p=>{out+=`<tr><td>${p.agent}</td><td>${p.name}</td><td>${p.tier}</td><td>${p.rankText}</td><td>${p.kda}</td><td>${p.ratio}</td><td>${p.acs}</td><td>${p.adr}</td><td>${p.dd}</td><td>${p.hs}</td><td>${p.fk}</td><td>${p.fd}</td><td>${p.mk}</td></tr>`;});
    out+="</tbody></table>"; return out;
  }
  html+=render(m.team1,"팀 A",sA>sB); html+=render(m.team2,"팀 B",sB>sA);
  document.getElementById("detailContent").innerHTML=html; new bootstrap.Modal(document.getElementById("detailModal")).show();
}

// 검색
async function searchStats(){
  const q=document.getElementById("searchUser").value.trim(); if(!q)return;
  const snaps=await db.collection("matches").get();
  let games=0,wins=0,k=0,d=0,a=0,acs=0,adr=0,dd=0,hs=0; let mapStats={},agentStats={},teamStats={};
  snaps.forEach(doc=>{
    const m=doc.data(); let [sA,sB]=m.score.split("-").map(x=>+x);
    function proc(team,isA){team.forEach(p=>{if(p.name===q){games++;let [kk,ddt,aa]=p.kda.split('/').map(x=>+x||0);k+=kk;d+=ddt;a+=aa;acs+=+p.acs||0;adr+=+p.adr||0;dd+=(+p.dd||0);hs+=(parseInt(p.hs)||0);
      if(!mapStats[m.map])mapStats[m.map]={g:0,w:0}; mapStats[m.map].g++;
      if(!agentStats[p.agent])agentStats[p.agent]={g:0,w:0}; agentStats[p.agent].g++;
      let win=(isA?sA>sB:sB>sA); if(win){wins++;mapStats[m.map].w++;agentStats[p.agent].w++;}
      [...m.team1,...m.team2].forEach(o=>{if(o.name!==q){if(!teamStats[o.name])teamStats[o.name]={same:0,sameW:0,opp:0,oppW:0}; let same=(isA?m.team1.includes(o):m.team2.includes(o));
        if(same){teamStats[o.name].same++;if(win)teamStats[o.name].sameW++;} else {teamStats[o.name].opp++;if(win)teamStats[o.name].oppW++;}}});}});}
    proc(m.team1,true); proc(m.team2,false);
  });
  let html=`<h5>${q} 전적 요약</h5><p>총 게임:${games}, 승:${wins}, 패:${games-wins}, 승률:${((wins/games*100)||0).toFixed(1)}%</p><p>K/D/A:${k}/${d}/${a}</p><p>평균 ACS:${(acs/games).toFixed(1)} / ADR:${(adr/games).toFixed(1)} / DDΔ:${(dd/games).toFixed(1)} / HS:${(hs/games).toFixed(1)}%</p>`;
  html+="<h6>맵별 승률</h6><ul>"; for(let m in mapStats){let ms=mapStats[m];html+=`<li>${m}: ${ms.w}/${ms.g} (${(ms.w/ms.g*100).toFixed(1)}%)</li>`;} html+="</ul><h6>요원별 승률</h6><ul>";
  for(let ag in agentStats){let as=agentStats[ag];html+=`<li>${ag}: ${as.w}/${as.g} (${(as.w/as.g*100).toFixed(1)}%)</li>`;} html+="</ul><h6>같은팀/상대팀 승률</h6><ul>";
  for(let n in teamStats){let ts=teamStats[n];html+=`<li>${n}: 같은팀 ${ts.sameW}/${ts.same} (${((ts.sameW/ts.same*100)||0).toFixed(1)}%) / 상대팀 ${ts.oppW}/${ts.opp} (${((ts.oppW/ts.opp*100)||0).toFixed(1)}%)</li>`;} html+="</ul>";
  document.getElementById("searchResult").innerHTML=html;
}

// 티어표
db.collection("matches").onSnapshot(snapshot=>{
  let stats={}; snapshot.forEach(doc=>{const m=doc.data(); let [sA,sB]=m.score.split("-").map(x=>+x);
    m.team1.forEach(p=>{if(!stats[p.name])stats[p.name]={games:0,wins:0,mmr:1000}; stats[p.name].games++; if(sA>sB)stats[p.name].wins++; stats[p.name].mmr+=(sA>sB?25:-20);});
    m.team2.forEach(p=>{if(!stats[p.name])stats[p.name]={games:0,wins:0,mmr:1000}; stats[p.name].games++; if(sB>sA)stats[p.name].wins++; stats[p.name].mmr+=(sB>sA?25:-20);});
  });
  let arr=Object.entries(stats).map(([name,v])=>({...v,name})).sort((a,b)=>b.mmr-a.mmr);
  const tbody=document.getElementById("tierTable"); tbody.innerHTML=""; arr.forEach((u,i)=>{let tier=getTier(u.mmr);
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${u.name}</td><td>${tier}</td><td>${u.mmr}</td><td>${u.games}</td><td>${u.wins}</td><td>${u.games-u.wins}</td><td>${((u.wins/u.games*100)||0).toFixed(1)}%</td></tr>`;});
});
</script>
</body>
</html>
