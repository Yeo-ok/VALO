<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>발로란트 내전 전적 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#111; color:#eee; }
    .nav-tabs .nav-link.active { background:#222; color:#0ff; font-weight:bold; }
    .table { color:#ddd; }
    .card { background:#1a1a1a; border:1px solid #333; }
    .page-link { background:#222; color:#0ff; border:1px solid #333; }
    .page-item.active .page-link { background:#0ff; color:#000; }
    .modal-content { background:#1a1a1a; color:#eee; }
    pre { background:#222; padding:10px; border-radius:5px; color:#0f0; }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center mb-4">발로란트 내전 전적 시스템</h1>
  <ul class="nav nav-tabs justify-content-center mb-4">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inputTab">내전 정보 입력</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#recordTab">내전 전적</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#searchTab">전적 검색</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tierTab">티어표</a></li>
  </ul>

  <div class="tab-content">
    <!-- 내전 정보 입력 -->
    <div class="tab-pane fade show active" id="inputTab">
      <div class="card p-3">
        <h4>내전 정보 입력</h4>
        <form id="matchForm">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">맵 이름</label>
              <input type="text" class="form-control" name="map" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">스코어</label>
              <input type="text" class="form-control" name="score" placeholder="예: 13-11" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">날짜</label>
              <input type="date" class="form-control" name="date" required>
            </div>
          </div>
          <hr>
          <label class="form-label">전적 복붙</label>
          <textarea class="form-control mb-2" rows="12" name="raw" placeholder="전적 복붙"></textarea>
          <button type="submit" class="btn btn-primary mt-2">저장</button>
        </form>
      </div>
    </div>

    <!-- 내전 전적 -->
    <div class="tab-pane fade" id="recordTab">
      <h4>내전 전적</h4>
      <div id="recordList"></div>
      <nav class="d-flex justify-content-center mt-3">
        <ul class="pagination" id="pagination"></ul>
      </nav>
    </div>

    <!-- 전적 검색 -->
    <div class="tab-pane fade" id="searchTab">
      <h4>전적 검색</h4>
      <input type="text" id="searchUser" class="form-control mb-2" placeholder="닉네임#태그 입력">
      <button class="btn btn-info mb-3" onclick="searchStats()">검색</button>
      <div id="searchResult"></div>
    </div>

    <!-- 티어표 -->
    <div class="tab-pane fade" id="tierTab">
      <h4>티어표</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>순위</th><th>닉네임</th><th>MMR</th><th>총 게임</th><th>승</th><th>패</th><th>승률</th>
          </tr>
        </thead>
        <tbody id="tierTable"></tbody>
      </table>
      <h5 class="mt-4">MMR 변동 가중치</h5>
      <pre>
기본: 승리 +25, 패배 -20
ACS: 상위 30% +5, 하위 30% -5
KDA: ±0~5
FK/FD/MK 보정
헤드율: 평균 이상 +3, 이하 -3
연승/연패: 3연승 +10, 5연승 +20 / 3연패 -10, 5연패 -20
MVP: 최근 10판 중 1개당 +2, 최대 +20
      </pre>
    </div>
  </div>
</div>

<!-- 상세 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">전적 상세</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailContent"></div>
    </div>
  </div>
</div>

<script>
  // Firebase Init
  const firebaseConfig = {
    apiKey:"AIzaSyDw2nAlGyepFTQQVN8m6slQmtLyc5vR0_s",
    authDomain:"valo-cf536.firebaseapp.com",
    projectId:"valo-cf536",
    storageBucket:"valo-cf536.appspot.com",
    messagingSenderId:"463328045633",
    appId:"1:463328045633:web:7785fd381903d8cee874c0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- 전적 파싱 ---
  function parseMatch(raw){
    const lines=raw.split("\n").map(l=>l.trim()).filter(l=>l);
    let players=[];
    for(let i=0;i<lines.length;i+=11){
      let p={
        agent:lines[i]||"",
        name:lines[i+1]||"",
        tierRank:lines[i+2]||"",
        tier:lines[i+3]||"",
        rankText:lines[i+5]||"",
        kda:lines[i+6]||"",
        ratio:lines[i+7]||"",
        acs:lines[i+8]||"",
        adr:lines[i+9]||"",
        dd:lines[i+10]?.split("\t")[1]||"",
        hs:lines[i+10]?.split("\t")[2]||"",
        fk:lines[i+10]?.split("\t")[3]||"",
        fd:lines[i+10]?.split("\t")[4]||"",
        mk:lines[i+10]?.split("\t")[5]||""
      };
      if(p.name) players.push(p);
    }
    return players;
  }

  // --- 저장 ---
  document.getElementById("matchForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const players=parseMatch(data.raw);
    await db.collection("matches").add({
      map:data.map,
      score:data.score,
      date:data.date,
      players:players,
      created:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("저장 완료!");
    e.target.reset();
  });

  // --- 페이지네이션 ---
  let currentPage=1, pageSize=10, totalDocs=0;
  async function loadPage(page){
    currentPage=page;
    const snap=await db.collection("matches").orderBy("created","desc").get();
    totalDocs=snap.size;
    const start=(page-1)*pageSize;
    const docs=snap.docs.slice(start,start+pageSize);
    const list=document.getElementById("recordList");
    list.innerHTML="";
    docs.forEach(doc=>{
      const m=doc.data();
      const div=document.createElement("div");
      div.className="card p-2 mb-2";
      div.innerHTML=`<b>${m.map}</b> - ${m.score} (${m.date})`;
      div.onclick=()=>showDetail(m);
      list.appendChild(div);
    });
    renderPagination();
  }
  function renderPagination(){
    const pages=Math.ceil(totalDocs/pageSize);
    const pag=document.getElementById("pagination");
    pag.innerHTML="";
    const prev=document.createElement("li");
    prev.className="page-item"+(currentPage===1?" disabled":"");
    prev.innerHTML=`<a class="page-link" href="#">이전</a>`;
    prev.onclick=()=>{if(currentPage>1)loadPage(currentPage-1)};
    pag.appendChild(prev);
    for(let i=1;i<=pages;i++){
      const li=document.createElement("li");
      li.className="page-item"+(i===currentPage?" active":"");
      li.innerHTML=`<a class="page-link" href="#">${i}</a>`;
      li.onclick=()=>loadPage(i);
      pag.appendChild(li);
    }
    const next=document.createElement("li");
    next.className="page-item"+(currentPage===pages?" disabled":"");
    next.innerHTML=`<a class="page-link" href="#">다음</a>`;
    next.onclick=()=>{if(currentPage<pages)loadPage(currentPage+1)};
    pag.appendChild(next);
  }

  // --- 상세 모달 ---
  function showDetail(m){
    let html=`<h5>${m.map} (${m.score}, ${m.date})</h5>`;
    html+=`<table class="table table-bordered table-sm">
      <thead><tr>
        <th>요원</th><th>닉네임</th><th>티어</th><th>순위</th>
        <th>KDA</th><th>비율</th><th>ACS</th><th>ADR</th><th>DDΔ</th>
        <th>HS%</th><th>FK</th><th>FD</th><th>MK</th>
      </tr></thead><tbody>`;
    m.players.forEach(p=>{
      html+=`<tr>
        <td>${p.agent}</td><td>${p.name}</td><td>${p.tierRank}</td><td>${p.rankText}</td>
        <td>${p.kda}</td><td>${p.ratio}</td><td>${p.acs}</td><td>${p.adr}</td><td>${p.dd}</td>
        <td>${p.hs}</td><td>${p.fk}</td><td>${p.fd}</td><td>${p.mk}</td>
      </tr>`;
    });
    html+="</tbody></table>";
    document.getElementById("detailContent").innerHTML=html;
    new bootstrap.Modal(document.getElementById("detailModal")).show();
  }

  // --- 전적 검색 ---
  async function searchStats(){
    const q=document.getElementById("searchUser").value.trim();
    if(!q)return;
    const snaps=await db.collection("matches").get();
    let games=0,wins=0,kills=0,deaths=0,assists=0,acs=0,adr=0,dd=0,hs=0;
    let mapStats={},agentStats={},teamStats={};
    snaps.forEach(doc=>{
      const m=doc.data();
      m.players.forEach(p=>{
        if(p.name===q){
          games++;
          let [k,d,a]=p.kda.split('/').map(x=>+x||0);
          kills+=k;deaths+=d;assists+=a;
          acs+=+p.acs||0; adr+=+p.adr||0; dd+=(+p.dd||0); hs+=(parseInt(p.hs)||0);
          // 맵별
          if(!mapStats[m.map])mapStats[m.map]={g:0,w:0};
          mapStats[m.map].g++;
          // 요원별
          if(!agentStats[p.agent])agentStats[p.agent]={g:0,w:0};
          agentStats[p.agent].g++;
          // 승패
          let [sA,sB]=m.score.split("-").map(x=>+x);
          let teamA=m.players.slice(0,5); // 단순: 첫 5명=팀A
          let userTeam=teamA.find(x=>x.name===q)?"A":"B";
          let win=(userTeam==="A"?sA>sB:sB>sA);
          if(win){wins++;mapStats[m.map].w++;agentStats[p.agent].w++;}
          // 팀별 승률
          m.players.forEach(o=>{
            if(o.name!==q){
              if(!teamStats[o.name])teamStats[o.name]={same:0,sameW:0,opp:0,oppW:0};
              if(teamA.find(x=>x.name===q)===!!teamA.find(x=>x.name===o.name)){
                teamStats[o.name].same++; if(win)teamStats[o.name].sameW++;
              }else{
                teamStats[o.name].opp++; if(win)teamStats[o.name].oppW++;
              }
            }
          });
        }
      });
    });
    let html=`<h5>${q} 전적 요약</h5>
    <p>총 게임:${games}, 승:${wins}, 패:${games-wins}, 승률:${((wins/games*100)||0).toFixed(1)}%</p>
    <p>K/D/A 합계:${kills}/${deaths}/${assists}</p>
    <p>평균 ACS:${(acs/games).toFixed(1)} / ADR:${(adr/games).toFixed(1)} / DDΔ:${(dd/games).toFixed(1)} / HS:${(hs/games).toFixed(1)}%</p>`;
    html+="<h6>맵별 승률</h6><ul>";
    for(let m in mapStats){let ms=mapStats[m];html+=`<li>${m}: ${ms.w}/${ms.g} (${(ms.w/ms.g*100).toFixed(1)}%)</li>`;}
    html+="</ul><h6>요원별 승률</h6><ul>";
    for(let ag in agentStats){let as=agentStats[ag];html+=`<li>${ag}: ${as.w}/${as.g} (${(as.w/as.g*100).toFixed(1)}%)</li>`;}
    html+="</ul><h6>같은팀/상대팀 승률</h6><ul>";
    for(let n in teamStats){let ts=teamStats[n];html+=`<li>${n}: 같은팀 ${ts.sameW}/${ts.same} (${((ts.sameW/ts.same*100)||0).toFixed(1)}%) / 상대팀 ${ts.oppW}/${ts.opp} (${((ts.oppW/ts.opp*100)||0).toFixed(1)}%)</li>`;}
    html+="</ul>";
    document.getElementById("searchResult").innerHTML=html;
  }

  // --- 티어표 ---
  db.collection("matches").onSnapshot(snapshot=>{
    let stats={};
    snapshot.forEach(doc=>{
      const m=doc.data();
      let [sA,sB]=m.score.split("-").map(x=>+x);
      let teamA=m.players.slice(0,5); // 단순
      m.players.forEach((p,idx)=>{
        if(!stats[p.name])stats[p.name]={games:0,wins:0,mmr:1000,recent:[]};
        stats[p.name].games++;
        let win=(idx<5? sA>sB : sB>sA);
        if(win)stats[p.name].wins++;
        stats[p.name].recent.push({win,acs:+p.acs||0,mvp:p.rankText==="MVP"});
      });
    });
    // MMR 계산
    for(let n in stats){
      let u=stats[n]; let mmr=1000;
      u.recent.slice(-10).forEach(r=>{
        mmr+=(r.win?25:-20);
        if(r.acs>200)mmr+=5; else if(r.acs<150)mmr-=5;
        if(r.mvp)mmr+=2;
      });
      stats[n].mmr=mmr;
    }
    let arr=Object.entries(stats).map(([name,v])=>({...v,name}));
    arr.sort((a,b)=>b.mmr-a.mmr);
    const tbody=document.getElementById("tierTable");
    tbody.innerHTML="";
    arr.forEach((u,i)=>{
      tbody.innerHTML+=`<tr>
        <td>${i+1}</td><td>${u.name}</td><td>${u.mmr}</td>
        <td>${u.games}</td><td>${u.wins}</td><td>${u.games-u.wins}</td>
        <td>${((u.wins/u.games*100)||0).toFixed(1)}%</td>
      </tr>`;
    });
  });

  // 초기 로드
  loadPage(1);
</script>
</body>
</html>
