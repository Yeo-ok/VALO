<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>발로란트 내전 전적 시스템 v0.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#111; color:#eee; }
    .nav-tabs .nav-link.active { background:#222; color:#0ff; font-weight:bold; }
    .table { color:#ddd; font-size:0.9rem; }
    .table thead { background:#222; }
    .table-striped tbody tr:nth-of-type(odd) { background:#1a1a1a; }
    .card { background:#1a1a1a; border:1px solid #333; cursor:pointer; }
    .card:hover { border-color:#0ff; }
    .modal-content { background:#1a1a1a; color:#eee; }
    .badge-win { background:#28a745; }
    .badge-lose { background:#dc3545; }
    #version { position: fixed; top: 5px; left: 10px; font-size: 0.9rem; color:#0ff; }
  </style>
</head>
<body>
<div id="version">v0.6</div>
<div class="container py-4">
  <h1 class="text-center mb-4">발로란트 내전 전적 시스템</h1>
  <ul class="nav nav-tabs justify-content-center mb-4">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inputTab">내전 정보 입력</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#recordTab">내전 전적</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="inputTab">
      <div class="card p-3">
        <form id="matchForm">
          <div class="row g-3">
            <div class="col-md-4"><input type="text" class="form-control" name="map" placeholder="맵 이름" required></div>
            <div class="col-md-4"><input type="text" class="form-control" name="score" placeholder="스코어 (ex 13-11)" required></div>
            <div class="col-md-4"><input type="date" class="form-control" name="date" required></div>
          </div>
          <hr>
          <textarea class="form-control mb-2" rows="20" name="raw" placeholder="전적 복붙" required></textarea>
          <button type="submit" class="btn btn-primary">저장</button>
        </form>
      </div>
    </div>
    <div class="tab-pane fade" id="recordTab">
      <h4>내전 전적</h4>
      <div id="recordList"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">전적 상세</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body" id="detailContent"></div>
  </div></div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyDw2nAlGyepFTQQVN8m6slQmtLyc5vR0_s",authDomain:"valo-cf536.firebaseapp.com",projectId:"valo-cf536",storageBucket:"valo-cf536.appspot.com",messagingSenderId:"463328045633",appId:"1:463328045633:web:7785fd381903d8cee874c0"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// --- 개선된 파서 ---
function parsePlayers(raw){
  const lines = raw.split("\n").map(l=>l.trim()).filter(Boolean);
  const players = [];
  let buffer = [];
  for(let line of lines){
    buffer.push(line);
    // KDA 패턴이 포함되면 하나의 플레이어 완성
    if(/\d+\s*\/\s*\d+\s*\/\s*\d+/.test(line)){
      const chunk = buffer.join(" ");
      players.push(extractPlayer(chunk));
      buffer = [];
    }
  }
  return players;
}

function extractPlayer(chunk){
  const p={};
  // 요원
  const agentMatch = chunk.match(/^(네온|사이퍼|소바|오멘|브림스톤|아이소|요루|체임버)/);
  p.agent = agentMatch?agentMatch[0]:"";
  // 닉네임
  const nameMatch = chunk.match(/([가-힣A-Za-z0-9]+#[A-Za-z0-9]+)/);
  p.name = nameMatch?nameMatch[0]:"";
  // 티어
  const tierMatch = chunk.match(/(아이언|브론즈|실버|골드|플래티넘|다이아몬드|이모탈|레디언트)\s*\d?/);
  p.tier = tierMatch?tierMatch[0]:"";
  // 순위
  const rankMatch = chunk.match(/(OVP|MVP|\d+(st|nd|rd|th))/);
  p.rankText = rankMatch?rankMatch[0]:"";
  // KDA
  const kdaMatch = chunk.match(/\d+\s*\/\s*\d+\s*\/\s*\d+/);
  p.kda = kdaMatch?kdaMatch[0]:"";
  // 비율
  const ratioMatch = chunk.match(/\d+(\.\d+)?:1/);
  p.ratio = ratioMatch?ratioMatch[0]:"";
  // ACS / ADR / DDΔ / HS% / FK / FD / MK
  const nums = chunk.split(/\s+/).filter(x=>/^[\d\+\-]+%?$/.test(x));
  p.acs = nums[0]||""; p.adr = nums[1]||""; p.dd = nums[2]||""; p.hs = nums[3]||"";
  p.fk = nums[4]||""; p.fd = nums[5]||""; p.mk = nums[6]||"";
  return p;
}

function parseMatch(raw){
  let [teamAraw,teamBraw]=raw.split(/승리적군|팀 B|팀 B 승리|팀 B 패배/);
  return {
    team1: parsePlayers(teamAraw||""),
    team2: parsePlayers(teamBraw||"")
  };
}

// 저장
document.getElementById("matchForm").addEventListener("submit",async e=>{
  e.preventDefault();
  let data=Object.fromEntries(new FormData(e.target).entries());
  let parsed=parseMatch(data.raw);
  await db.collection("matches").add({
    map:data.map,score:data.score,date:data.date,
    team1:parsed.team1,team2:parsed.team2,
    created:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("저장 완료!"); e.target.reset();
});

// 목록
db.collection("matches").orderBy("created","desc").onSnapshot(snap=>{
  let list=document.getElementById("recordList"); list.innerHTML="";
  snap.forEach(doc=>{
    let m=doc.data();
    let card=document.createElement("div");
    card.className="card p-2 mb-2";
    card.innerHTML=`<b>${m.map}</b> - ${m.score} (${m.date})`;
    card.onclick=()=>showDetail(m);
    list.appendChild(card);
  });
});

function showDetail(m){
  let [sA,sB]=m.score.split("-").map(x=>+x);
  let html=`<h5>${m.map} (${m.score}, ${m.date})</h5>`;
  function render(players,label,isWin){
    let badge=isWin?'<span class="badge badge-win">승리</span>':'<span class="badge badge-lose">패배</span>';
    let out=`<h6>${label} ${badge}</h6><table class="table table-bordered table-sm table-striped"><thead><tr>
    <th>요원</th><th>닉네임</th><th>티어</th><th>순위</th><th>KDA</th><th>비율</th><th>ACS</th><th>ADR</th><th>DDΔ</th><th>HS%</th><th>FK</th><th>FD</th><th>MK</th></tr></thead><tbody>`;
    players.forEach(p=>{
      out+=`<tr><td>${p.agent}</td><td>${p.name}</td><td>${p.tier}</td><td>${p.rankText}</td><td>${p.kda}</td><td>${p.ratio}</td><td>${p.acs}</td><td>${p.adr}</td><td>${p.dd}</td><td>${p.hs}</td><td>${p.fk}</td><td>${p.fd}</td><td>${p.mk}</td></tr>`;
    });
    out+="</tbody></table>"; return out;
  }
  html+=render(m.team1,"팀 A",sA>sB);
  html+=render(m.team2,"팀 B",sB>sA);
  document.getElementById("detailContent").innerHTML=html;
  new bootstrap.Modal(document.getElementById("detailModal")).show();
}
</script>
</body>
</html>
