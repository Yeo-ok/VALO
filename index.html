<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>발로란트 내전 플랫폼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1113; --card:#151618; --accent:#ff4655; --muted:#9aa3ad; --text:#eee;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b0c0d 0%,#0f1113 100%);color:var(--text);-webkit-font-smoothing:antialiased;padding:24px}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{margin:0;color:var(--accent);font-size:20px}
    .top-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    input,select,button,textarea{font-family:inherit}
    .card{background:var(--card);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab-btn{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer}
    .tab-btn.active{background:rgba(255,255,255,0.03);color:var(--text);border-color:rgba(255,255,255,0.04)}
    .hidden{display:none!important}
    .cols{display:flex;gap:16px}
    .col{flex:1}
    .input-group{margin:8px 0;position:relative}
    .input{width:100%;padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0d0e10;color:var(--text)}
    textarea.input{resize:vertical}
    label.small{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .player-row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
    .player-row .input{width:140px}
    .player-row .input.small{width:80px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .tier-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
    .tier-icon{width:36px;height:20px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#111;font-size:12px}
    .icon-iron{background:#8a8a8a;color:#fff}
    .icon-bronze{background:#a76a31;color:#fff}
    .icon-silver{background:#aeb8c0;color:#111}
    .icon-gold{background:#f0c84a;color:#111}
    .icon-platinum{background:#57d6c8;color:#111}
    .icon-diamond{background:#5a8ee6;color:#fff}
    .icon-immortal{background:#7a4bd6;color:#fff}
    .icon-radiant{background:linear-gradient(90deg,#ffd36a,#ff6b8a);color:#111}
    .footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>발로란트 내전 플랫폼</h1>
      <div class="top-right"><div id="modeLabel" class="small-muted">모드: 로그인</div></div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card">
      <h2>모드 선택</h2>
      <div class="input-group">
        <label class="small">모드 입력 (관전 또는 관리자)</label>
        <input id="modeInput" class="input" type="text" placeholder="예: 관전 또는 관리자"/>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="login()">입장</button>
        <button class="btn ghost" onclick="autoSpectate()">관전으로 바로 입장</button>
      </div>
    </div>

    <!-- MAIN AREA -->
    <div id="mainArea" class="hidden">
      <div id="globalTabs" class="tabs card" style="margin-top:12px;padding:8px"></div>
      <div id="contentArea" style="margin-top:12px;"></div>
    </div>
    <div class="footer">관리자 기능 사용 시 삭제는 Firebase에서 완전 삭제됩니다.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig={apiKey:"AIzaSyDw2nAlGyepFTQQVN8m6slQmtLyc5vR0_s",authDomain:"valo-cf536.firebaseapp.com",projectId:"valo-cf536",storageBucket:"valo-cf536.appspot.com",messagingSenderId:"463328045633",appId:"1:463328045633:web:7785fd381903d8cee874c0"};
    const app=initializeApp(firebaseConfig);const db=getFirestore(app);

    let MODE=null,users=[],matches=[],currentMatchPage=0,PAGE_SIZE=5;

    async function loadUsers(){users=[];const snap=await getDocs(collection(db,"users"));snap.forEach(s=>users.push(s.data()));}
    async function loadMatches(){matches=[];const snap=await getDocs(query(collection(db,"matches"),orderBy("date","desc")));snap.forEach(s=>{let d=s.data();d._id=s.id;matches.push(d);});}

    window.login=async function(){const val=document.getElementById("modeInput").value.trim();if(val!=="관전"&&val!=="관리자")return alert("정확히 입력");MODE=val;document.getElementById("loginScreen").classList.add("hidden");document.getElementById("mainArea").classList.remove("hidden");document.getElementById("modeLabel").innerText=`모드: ${MODE}`;await loadUsers();await loadMatches();renderTopTabs();openDefaultTab();};
    window.autoSpectate=async function(){document.getElementById("modeInput").value="관전";await window.login();};

    function renderTopTabs(){const c=document.getElementById("globalTabs");c.innerHTML="";if(MODE==="관전"){c.appendChild(tabBtn("내전 기록",()=>renderSpectateRecords()));c.appendChild(tabBtn("전적 검색",()=>renderSpectateSearch()));c.appendChild(tabBtn("티어표",()=>renderSpectateTiers()));}else{c.appendChild(tabBtn("내전 입력",()=>renderAdminInput()));c.appendChild(tabBtn("내전 관리",()=>renderAdminManage()));c.appendChild(tabBtn("유저 관리",()=>renderAdminUsers()));c.appendChild(tabBtn("전적 검색",()=>renderSpectateSearch()));}}
    function tabBtn(text,onClick){const b=document.createElement("button");b.className="tab-btn";b.innerText=text;b.onclick=()=>{document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));b.classList.add("active");onClick();};return b;}
    function openDefaultTab(){const f=document.querySelector(".tab-btn");if(f)f.click();}

    // 관전: 내전 기록
    function renderSpectateRecords(){const content=document.getElementById("contentArea");content.innerHTML="";currentMatchPage=0;const box=document.createElement("div");box.className="card";box.innerHTML=`<h2>내전 기록</h2><div id="recordsList"></div><div style="display:flex;justify-content:center;gap:8px;margin-top:10px"><button class="btn ghost" id="prevPage">&lt;</button><div id="pageInfo" class="small-muted"></div><button class="btn ghost" id="nextPage">&gt;</button></div>`;content.appendChild(box);document.getElementById("prevPage").onclick=()=>{if(currentMatchPage>0){currentMatchPage--;updateRecordsList();}};document.getElementById("nextPage").onclick=()=>{if((currentMatchPage+1)*PAGE_SIZE<matches.length){currentMatchPage++;updateRecordsList();}};updateRecordsList();}
    function updateRecordsList(){const listDiv=document.getElementById("recordsList");listDiv.innerHTML="";const start=currentMatchPage*PAGE_SIZE;const page=matches.slice(start,start+PAGE_SIZE);page.forEach(m=>listDiv.appendChild(renderMatchRecord(m)));document.getElementById("pageInfo").innerText=`페이지 ${currentMatchPage+1} / ${Math.max(1,Math.ceil(matches.length/PAGE_SIZE))}`;}
    function renderMatchRecord(m){const div=document.createElement("div");div.className="card";div.style.marginBottom="8px";div.innerHTML=`<div class="small-muted">${(m.map||'-')} / ${m.score||'-'} / 승:${m.winner}</div>`;["team1","team2"].forEach(t=>{const team=document.createElement("div");team.innerHTML=`<div style="font-weight:600;margin-top:6px">${t==="team1"?"팀1":"팀2"} ${m.winner===t?'<span style="color:var(--accent)">승리</span>':""}</div>`;(m[t]||[]).forEach(p=>{const row=document.createElement("div");row.className="small-muted";row.innerText=`${p.name||p.riotid}: ${p.kills}/${p.deaths}/${p.assists} | ACS:${p.acs||0} ADR:${p.adr||0} HS:${p.hs||0}%`;team.appendChild(row);});div.appendChild(team);});return div;}

    // 관전: 전적 검색
    function renderSpectateSearch(){const content=document.getElementById("contentArea");content.innerHTML="";const box=document.createElement("div");box.className="card";box.innerHTML=`<h2>전적 검색</h2><input id="searchInput" class="input" placeholder="닉네임 또는 Riot ID"/><button class="btn" id="searchBtn">검색</button><div id="searchResult" style="margin-top:12px"></div>`;content.appendChild(box);document.getElementById("searchBtn").onclick=()=>doSearch();}
    function doSearch(){const q=document.getElementById("searchInput").value.trim();const out=document.getElementById("searchResult");out.innerHTML="";if(!q)return;let results=[];matches.forEach(m=>["team1","team2"].forEach(t=>(m[t]||[]).forEach(p=>{if((p.name&&p.name.includes(q))||(p.riotid&&p.riotid.includes(q)))results.push({m,team:t,p});})));if(results.length===0){out.innerHTML=`<div class="small-muted">검색결과 없음</div>`;return;}let k=0,d=0,a=0,g=0,acs=0,adr=0;results.forEach(r=>{k+=r.p.kills||0;d+=r.p.deaths||0;a+=r.p.assists||0;acs+=r.p.acs||0;adr+=r.p.adr||0;g++;});out.innerHTML=`<div class="small-muted">게임수:${g} KDA:${((k+a)/Math.max(1,d)).toFixed(2)} 평균ACS:${(acs/g).toFixed(1)} 평균ADR:${(adr/g).toFixed(1)}</div>`;}

    // 관전: 티어표
    function renderSpectateTiers(){const content=document.getElementById("contentArea");content.innerHTML="";const box=document.createElement("div");box.className="card";box.innerHTML=`<h2>티어표</h2><div id="tierTableWrap"></div>`;content.appendChild(box);computeAllStatsAndMMR();updateTierTable();}
    let usersStats={};
    function computeAllStatsAndMMR(){usersStats={};matches.forEach(m=>["team1","team2"].forEach(t=>(m[t]||[]).forEach(p=>{if(!usersStats[p.riotid])usersStats[p.riotid]={name:p.name,riotid:p.riotid,games:0,k:0,d:0,a:0,acs:0,adr:0};let st=usersStats[p.riotid];st.games++;st.k+=p.kills||0;st.d+=p.deaths||0;st.a+=p.assists||0;st.acs+=p.acs||0;st.adr+=p.adr||0;})));Object.values(usersStats).forEach(st=>{st.avgACS=st.games?st.acs/st.games:0;st.avgADR=st.games?st.adr/st.games:0;st.kda=(st.k+st.a)/Math.max(1,st.d);st.mmr=Math.round(1000+st.avgACS+st.avgADR+st.kda*50);st.tier=mmrToTier(st.mmr);});}
    function mmrToTier(m){if(m<1200)return{name:"브론즈",icon:"icon-bronze"};if(m<1500)return{name:"실버",icon:"icon-silver"};if(m<1800)return{name:"골드",icon:"icon-gold"};if(m<2100)return{name:"플래티넘",icon:"icon-platinum"};if(m<2400)return{name:"다이아",icon:"icon-diamond"};if(m<2700)return{name:"이모탈",icon:"icon-immortal"};return{name:"레이디언트",icon:"icon-radiant"};}
    function updateTierTable(){const arr=Object.values(usersStats).sort((a,b)=>b.mmr-a.mmr);let html=`<table><thead><tr><th>순위</th><th>닉네임</th><th>MMR</th><th>티어</th><th>KDA</th><th>평균ACS</th><th>평균ADR</th></tr></thead><tbody>`;arr.forEach((u,i)=>{html+=`<tr><td>${i+1}</td><td>${u.name||u.riotid}</td><td>${u.mmr}</td><td><span class="tier-badge"><span class="tier-icon ${u.tier.icon}">${u.tier.name[0]}</span>${u.tier.name}</span></td><td>${u.kda.toFixed(2)}</td><td>${u.avgACS.toFixed(1)}</td><td>${u.avgADR.toFixed(1)}</td></tr>`;});html+="</tbody></table>";document.getElementById("tierTableWrap").innerHTML=html;}

    // 관리자: 입력
    function renderAdminInput(){const content=document.getElementById("contentArea");content.innerHTML="";const box=document.createElement("div");box.className="card";box.innerHTML=`<h2>내전 입력</h2>
      <div class="input-group"><label class="small">맵</label><input id="in_map" class="input"/></div>
      <div class="input-group"><label class="small">스코어</label><input id="in_score" class="input"/></div>
      <div class="input-group"><label class="small">승리팀</label><select id="in_winner" class="input"><option value="team1">팀1</option><option value="team2">팀2</option></select></div>
      <div class="input-group"><label class="small">전적 원본 텍스트</label><textarea id="rawText" class="input" rows="10"></textarea></div>
      <button class="btn" id="parseBtn">텍스트 파싱</button>
      <button class="btn" id="saveBtn">저장</button>`;content.appendChild(box);
      document.getElementById("parseBtn").onclick=()=>{const raw=document.getElementById("rawText").value;const parsed=parseValorantText(raw);window._parsedMatch=parsed;alert("파싱완료! 저장버튼을 누르세요.");};
      document.getElementById("saveBtn").onclick=async()=>{if(!window._parsedMatch)return alert("먼저 파싱");const m={map:document.getElementById("in_map").value,score:document.getElementById("in_score").value,winner:document.getElementById("in_winner").value,date:serverTimestamp(),...window._parsedMatch};await addDoc(collection(db,"matches"),m);await loadMatches();alert("저장완료");};}

    function parseValorantText(raw){let lines=raw.split("\n").map(x=>x.trim()).filter(x=>x);let team1=[],team2=[];let toTeam2=false;lines.forEach(line=>{if(line.includes("승리적군")){toTeam2=true;return;}if(line.match(/\d+\s*\/\s*\d+\s*\/\s*\d+/)){let name=line.split(/\s+/)[0];let kda=line.match(/(\d+)\s*\/\s*(\d+)\s*\/\s*(\d+)/);let kills=+kda[1],deaths=+kda[2],assists=+kda[3];let acsMatch=line.match(/\s(\d{2,3}\.\d{2})/);let acs=acsMatch?parseFloat(acsMatch[1]):0;let adrMatch=line.match(/\s(\d{2,3})\s*[+-]/);let adr=adrMatch?parseFloat(adrMatch[1]):0;let hs=line.match(/(\d+)%/);let hsVal=hs?+hs[1]:0;let obj={name,riotid:name,kills,deaths,assists,acs,adr,hs:hsVal};if(!toTeam2)team1.push(obj);else team2.push(obj);}});return{team1,team2};}

    // 관리자: 관리/유저 관리 (간단)
    function renderAdminManage(){const content=document.getElementById("contentArea");content.innerHTML="";const box=document.createElement("div");box.className="card";box.innerHTML="<h2>내전 관리</h2>";content.appendChild(box);matches.forEach(m=>{box.appendChild(renderMatchRecord(m));});}
    function renderAdminUsers(){const content=document.getElementById("contentArea");content.innerHTML="";const box=document.createElement("div");box.className="card";box.innerHTML="<h2>유저 관리</h2>";content.appendChild(box);users.forEach(u=>{let row=document.createElement("div");row.className="small-muted";row.innerText=`${u.name} (${u.riotid})`;box.appendChild(row);});}

    (async()=>{await loadUsers();await loadMatches();})();
  </script>
</body>
</html>
